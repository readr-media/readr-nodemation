name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR head refs
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-head

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...pr-head | base64 -w 0)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: review
        uses: appleboy/llm-action@v1
        with:
          base_url: https://generativelanguage.googleapis.com
          api_key: ${{ secrets.GEMINI_API_KEY }}
          model: gemini-2.5-pro
          system_prompt: |
            ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç¨‹å¼ç¢¼å¯©æŸ¥å°ˆå®¶ã€‚è«‹æ ¹æ“šä»¥ä¸‹æ¨™æº–å¯©æŸ¥ç¨‹å¼ç¢¼ï¼š
            1. ç¨‹å¼ç¢¼å“è³ªèˆ‡å¯è®€æ€§
            2. æ½›åœ¨çš„ Bug æˆ–å®‰å…¨æ¼æ´
            3. æ•ˆèƒ½å•é¡Œ
            4. æœ€ä½³å¯¦è¸å»ºè­°
            5. è«‹å‹™å¿…åš´æ ¼ä¾ç…§ tool_schema è¼¸å‡ºï¼Œä¸”ä¸è¦åŒ…å«ä»»ä½•å¤šé¤˜æ–‡å­—ã€‚
          input_prompt: |
            ä»¥ä¸‹æ˜¯ Pull Request çš„ diffï¼ˆbase64 ç·¨ç¢¼ï¼‰ï¼š
            è«‹å…ˆè§£ç¢¼å¾Œå†é€²è¡Œç¨‹å¼ç¢¼å¯©æŸ¥ã€‚

            ${{ steps.diff.outputs.diff }}
          tool_schema: |
            {
              "name": "code_review",
              "description": "ç¨‹å¼ç¢¼å¯©æŸ¥çµæœ",
              "parameters": {
                "type": "object",
                "properties": {
                  "score": {
                    "type": "string",
                    "description": "è©•åˆ† 1-10ï¼Œ10 ç‚ºæœ€ä½³"
                  },
                  "summary": {
                    "type": "string",
                    "description": "å¯©æŸ¥æ‘˜è¦ï¼Œ50 å­—ä»¥å…§"
                  },
                  "issues": {
                    "type": "string",
                    "description": "ç™¼ç¾çš„å•é¡Œï¼Œä»¥ markdown åˆ—è¡¨æ ¼å¼"
                  },
                  "suggestions": {
                    "type": "string",
                    "description": "æ”¹å–„å»ºè­°ï¼Œä»¥ markdown åˆ—è¡¨æ ¼å¼"
                  },
                  "approved": {
                    "type": "string",
                    "description": "æ˜¯å¦å»ºè­°åˆä½µï¼šyes æˆ– no"
                  }
                },
                "required": ["score", "summary", "issues", "suggestions", "approved"]
              }
            }
          tool_choice: |
            {
              "type": "function",
              "function": {
                "name": "code_review"
              }
            }

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.review.outputs.score }}' || 'N/A';
            const summary = '${{ steps.review.outputs.summary }}';
            const issues = '${{ steps.review.outputs.issues }}';
            const suggestions = '${{ steps.review.outputs.suggestions }}';
            const approved = '${{ steps.review.outputs.approved }}';

            const emoji = approved === 'yes' ? 'âœ…' : 'âš ï¸';

            const body = `## ${emoji} AI Code Review çµæœ

            **è©•åˆ†ï¼š** ${score}/10

            **æ‘˜è¦ï¼š** ${summary}

            ### ğŸ” ç™¼ç¾çš„å•é¡Œ
            ${issues || 'ç„¡'}

            ### ğŸ’¡ æ”¹å–„å»ºè­°
            ${suggestions || 'ç„¡'}

            ---
            *æ­¤å¯©æŸ¥ç”± AI è‡ªå‹•ç”¢ç”Ÿï¼Œåƒ…ä¾›åƒè€ƒ*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set review status
        if: steps.review.outputs.approved == 'no'
        run: |
          echo "::warning::AI å¯©æŸ¥å»ºè­°ï¼šæ­¤ PR éœ€è¦é€²ä¸€æ­¥ä¿®æ”¹"
          exit 1
